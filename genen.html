<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<script src="js/jquery-2.1.3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jrumble/1.3.0/jquery.jrumble.min.js" integrity="sha512-0vcUK0oQ15FtIrg1bbNL6zO2yB0pSZjPZERBNA0ZXIw/7jsSHu+rxxbpbM20wIaiEofTK9oPoP/Y8xvh3qoasQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="css/reset.css">
<link rel="stylesheet" href="css/sample.css">
<title>Smoking Kills</title>
</head>
<body>

  <!-- オープニングアニメーション -->
  <div class="start" id = "start">
    <div class="start_text">
      <h1>Smoking Kills</h1>
      <h2>for your good life</h2>
      <img src="./img/ペンギングレー.png" id="gpimg">
    </div>
    <div class="start_video">
      <video src="./movie/イントロ反転トリム.mp4" autoplay muted></video>
    </div>
  </div>


  <!-- タイトル -->
  <header id="header">
    <h1>Smoking Kills</h1>
  </header>


  <main>
    <!-- 入力画面 -->
    <div class="input_area" id="input_area">
      <div class="intro">
        <p>1日の上限本数とタバコ1箱の値段を登録しましょう。</p>
        <P>1日20本以上は禁止です</P>
      </div>
      <div class="input_area_honsu">
        <h2><span>Maximum Limit</span></h2>
        <input type="text" class="input_honsu" id="input_honsu">
      </div>
      <div class="input_area_price">
        <h2><span>Price</span></h2>
        <input type="text" class="input_price" id="input_price">
      </div>
      <div class="input_area_btn">
        <button id="btn">Submit</button>
      </div>
      <div class="kakunin_btn">
        <button id="kakunin_btn">確認</button>
      </div>
      <div class="img_area">
        <img src="./img/ペンギンあお.PNG" alt="" id="pimg">
      </div>
    </div>

    <!-- 入力後画面 -->
    <div class="output_area" id="output_area">
      <div class="output_area_top">
        <p>smoking causes ....</p>
      </div>
      <!-- 吸引ボタンエリア -->
      <div class="output_btn" id="output_btn">
        <button class="outbtn" id="outbtn">Smoke</button>
      </div>
      <!-- 表示エリア -->
      <div class="output_area_view">
        <div class="view_zan">
          <h2>Remaining</h2>
          <div class="honsu_output" id="honsu_output"></div>
        </div>
        <div class="view_totalprice">
          <h2>Your total is</h2>
          <div class="output_price" id="output_price"></div>
        </div>
      </div>
      <div class="outputimg">
        <img src="./img/ペンギンあお.PNG" alt="" id="outpimg">
      </div>

    </div>

    <div class="list_area">
      <div class="date_are">
        <p id ="nowdate"></p>
      </div>
      <div class="output_list" >
        <table id="list_table">
          <tr>
            <th>日付</th>
            <th>本数</th>
            <th>金額</th>
          </tr>
          <tr>
            <td id="list_date"></td>
            <td id="list_hon"></td>
            <td id="list_price"></td>
          </tr>
        </table>
      </div>
    </div>

  </main>


<script>
  //オープニング動画 のフェードアウトアニメーション
  $ ("#start").fadeOut(7000);

  //オープニング動画終了後の画面切り替え
  setTimeout(function(){
    $("#header").show();
    $("#input_area").show();
  },7000);


//入力画面
//入力欄画像横アニメーション   ペンギンが横に移動
$("#pimg").animate({ marginLeft: "80%", }, 4000, "linear", function () {
	$("#pimg").animate({ marginLeft: "0%" }, 4000,"linear", function() {
    $("#pimg").animate({ marginLeft: "80%", }, 4000, "linear", function () {
      $("#pimg").animate({ marginLeft: "0%" }, 4000,"linear", function() {
        $("#pimg").animate({ marginLeft: "60%" }, 4000,"linear")
      })
    })
  })
});
//ペンギンをプルプル震わせる
$("#pimg").jrumble({
  x: 0,
	y: 0,
	rotation: 5,
  speed: 100
});
$("#pimg").trigger('startRumble')


//出力画面
//ペンギンをプルプル震わせる
$("#outpimg").jrumble({
  x: 0,
	y: 0,
	rotation: 5,
  speed: 100
});
$("#outbtn").hover(function(){
	$("#outpimg").trigger('startRumble');
}, function(){
	$("#outpimg").trigger('stopRumble');
});





//ここから先は禁止
//グローバル変数
let honsu = ""; //上限本数 変動
let cshonsu = ""; //上限本数 固定
let price = 0; //一箱あたりの金額
let total_price = 0;  //トータル金額初期値

let last_price = localStorage.getItem("tprice"); //ローカルストレージ上 トータル金額
// let a = $.isNumeric(last_price); 数列判断
// alert(a); 


  //入力欄ボタンクリック時イベント
  $(btn).on("click", function(){

    //上限本数を数列で取得
    let input = $("#input_honsu").val();
    honsu  = Number(input);   //上限本数
    cshonsu = Number(input);
    //一箱の値段を数列で取得
    let input2 = $("#input_price").val();
    price  = Number(input2);  //一箱の料金 
    $("#honsu_output").text(honsu);
    $("#output_price").text("¥" + total_price);
    // alert(honsu)
    $("#input_area").hide();
    $("#output_area").show();

    //下記2行ローカルストレージに金額があった際は初期値として表示
    tprice_data = localStorage.getItem("tprice");
    $("#output_price").text(tprice_data);
  })

  //カウント欄 クリックイベント
  $("#outbtn").on("click", function(){
    //残本数 更新
    honsu -= 1;  //本数を減らす
    let priceone = price / 20; //一本あたりの値段
    // let total_price = 0;  //トータル金額初期値

    //残本数 更新
    $("#honsu_output").text(honsu);
    //const tkey = honsu;  //ローカルストレージ用変数 残本数

    //残本数 更新
    //トータル金額のif文
    if( total_price == 0){
      total_price = priceone
      let hyouji_price = Number(total_price) + Number(last_price) 
      $("#output_price").text("¥" + hyouji_price);
      localStorage.setItem("tprice", total_price);  //ローカルストレージへ保存(price)
      localStorage.setItem("honsu", honsu);   //ローカルストレージへ保存(honsu)
    }else{
      total_price  = total_price + priceone;
      let hyouji_price = Number(total_price) + Number(last_price) 
      $("#output_price").text("¥" + hyouji_price);
      // $("#output_price").text("¥" + total_price);
      const tprice = total_price;  //ローカルストレージ用変数　合計金額
      localStorage.setItem("tprice", tprice);  //ローカルストレージへ保存(price)
      localStorage.setItem("honsu", honsu);   //ローカルストレージへ保存(honsu)
    }

    //残本数ごとにボタンの色と、テキストを変更する
    if(honsu >= cshonsu*0.75){
      $("#outbtn").removeClass("button");
      $("#outbtn").addClass("level1");
    }else if(honsu >= cshonsu*0.5){
      $("#outbtn").removeClass("button");
      $("#outbtn").addClass("level2");
    }else if(honsu >= cshonsu*0.25){
      $("#outbtn").removeClass("button");
      $("#outbtn").addClass("level3");
    }else if(honsu > 0){
      $("#outbtn").removeClass("button");
      $("#outbtn").addClass("level4");
    }

  });


//日毎のデータ保存
  //日付
  $(function(){
    setInterval(function(){
      let todaydata = new Date(); 
      let year = todaydata.getFullYear(); //現在年
      let month = todaydata.getMonth() + 1; //現在月
      let day = todaydata.getDate();      //現在日
      let byou = todaydata.getSeconds(); //動作確認用
      // alert(day);

      //日付表示欄
      $("#nowdate").text(`${year}年${month}月${day}日${byou}`);
    }, 10000);
  });

  //日付表示欄の表記が変わった際に本数と合計金額を保存
  $("#nowdate").on('DOMSubtreeModified propertychange',function(){
      let todaydata = new Date(); 
      let year = todaydata.getFullYear(); //現在年
      let month = todaydata.getMonth() + 1; //現在月
      let day = todaydata.getDate();      //現在日
      

    const hkey =  `${year}年${month}月${day}日`;  //key日付


    let ttprice = localStorage.getItem("tprice");  //ローカルストレージから金額取得
    let last_honsu = localStorage.getItem("honsu"); //ローカルストレージから本数取得
    let datalist = [ttprice,last_honsu]  //ローカルストレージに保存するようの配列

    // let ttprice = $("#output_price").text();  //トータルプライス
    // let datalist = [honsu, ttprice]      //value用並列
    let jsdatalist = JSON.stringify(datalist);  //jsonに変換
    localStorage.setItem(hkey, jsdatalist);   //ローカルストレージに保存


    const hvalue = honsu;
    // const pkey = new Date();
    // const pvalue = $("#output_price").text();
    // localStorage.setItem(hkey, hvalue);
    // localStorage.setItem(pkey, pvalue);

  })
//ここまで

  //画面表示時にローカルストレージにデータがあるときは残本数を初期値として入力
  $(window).load(function () {
    honsu_data = localStorage.getItem("honsu");
    $("#input_honsu").val(honsu_data);
});



let output_date = localStorage.key(0)  //ローカルストレージから日にちを取得
// alert(output_date);
let output_json = localStorage.getItem(output_date);  //配列取得
let output_list_last = JSON.parse(output_json);  //配列をjsonから変換
// alert(output_list_last[0]);


//確認ボタン挙動
$("#kakunin_btn").on("click", function(){
  $("#input_area").hide();
  $("#list_date").text(output_date);
  $("#list_hon").text(output_list_last[0]);
  $("#list_price").text(output_list_last[1]);
})


</script>


</body>
</html>
